{% extends "base.html" %}
{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  
  <!-- Controls -->
  <div class="lg:col-span-1 bg-white p-6 rounded shadow">
    <h2 class="text-lg font-semibold mb-3">Generate Combos</h2>

    <label class="block text-sm text-gray-600">Budget (upper bound ₹)</label>
    <input id="budget" type="number" class="mt-2 mb-3 w-full border rounded px-3 py-2" placeholder="e.g. 400">

    <label class="block text-sm text-gray-600">Number of combos</label>
    <input id="num_combos" type="number" value="3" min="1" max="6" class="mt-2 mb-4 w-full border rounded px-3 py-2">

    <button id="btn_generate" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">
      Get Profit-Maximizing Combos
    </button>

    <div class="mt-4 text-xs text-gray-500">
      Each item in a combo gets a 2% discount.  
      Algorithm considers near-expiry, overstock, popularity, and co-occurrence to estimate projected incremental profit.
    </div>
  </div>

  <!-- Results -->
  <div class="lg:col-span-2 bg-white p-6 rounded shadow">
    <h2 class="text-lg font-semibold mb-3">Combos (ranked by projected incremental profit)</h2>
    <div id="combos_area" class="space-y-4 text-sm text-gray-700">
      <div class="text-gray-400">No combos yet. Enter budget and click "Get Profit-Maximizing Combos".</div>
    </div>
  </div>
</div>

<script>
async function generateCombos(){
  const budget = parseFloat(document.getElementById("budget").value) || 0;
  const num = parseInt(document.getElementById("num_combos").value) || 3;
  const resp = await fetch("/api/generate_combos", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({budget: budget, num_combos: num})
  });
  if(!resp.ok){ alert("Server error"); return; }
  const data = await resp.json();
  renderCombos(data.combos || []);
}

function renderCombos(combos){
  const area = document.getElementById("combos_area");
  area.innerHTML = "";
  if(!combos || combos.length===0){
    area.innerHTML = `<div class="text-gray-400">No combos found for the given budget.</div>`;
    return;
  }
  combos.forEach((c, idx) => {
    const card = document.createElement("div");
    card.className = "border rounded p-3 bg-gray-50";

    let html = `
      <div class="flex items-center justify-between mb-2">
        <div class="font-semibold">Combo ${idx+1}</div>
        <div class="text-sm text-gray-600">${c.items.length} items</div>
      </div>
      <div class="space-y-1">`;

    c.items.forEach(it => {
      html += `
        <div class="flex justify-between">
          <div>${it.item_name} <span class="text-xs text-gray-500">(${it.item_id})</span></div>
          <div class="text-green-600 font-medium">₹${it.discounted}</div>
        </div>`;
    });

    html += `</div>
      <div class="mt-2 flex items-center justify-between">
        <div class="text-sm">Total: <span class="font-bold">₹${c.total_price}</span></div>
        <div class="text-sm">Proj. Profit: <span class="font-semibold text-indigo-700">₹${c.projected_profit}</span></div>
      </div>
      <div class="mt-3 flex items-center gap-2">
        <button class="apply_btn bg-indigo-600 text-white px-3 py-1 rounded" data-idx="${idx}">Apply Combo</button>
        <button class="simulate_btn bg-gray-200 px-3 py-1 rounded" data-idx="${idx}">Simulate Add to Cart</button>
      </div>`;

    card.innerHTML = html;
    area.appendChild(card);
  });

  // Apply button → persist changes to inventory.json
  document.querySelectorAll(".apply_btn").forEach(b=>{
    b.onclick = async (e)=>{
      const i = parseInt(e.target.dataset.idx);
      const combo = combos[i];
      if(!confirm("This will decrement stock for the items in the combo (persisted to inventory.json). Proceed?")) return;
      const resp = await fetch("/api/apply_combo", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({items: combo.items.map(x=>x.item_id), qty: 1})
      });
      const r = await resp.json();
      if(r.success) alert("Combo applied. Inventory updated.");
      else alert("Failed to apply combo.");
    };
  });

  // Simulate button → client-side only
  document.querySelectorAll(".simulate_btn").forEach(b=>{
    b.onclick = (e)=>{
      const i = parseInt(e.target.dataset.idx);
      const combo = combos[i];
      alert("Simulated add to cart:\n" + combo.items.map(it => `${it.item_name} (₹${it.discounted})`).join("\n"));
    };
  });
}

document.getElementById("btn_generate").addEventListener("click", generateCombos);
</script>
{% endblock %}
